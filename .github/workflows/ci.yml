name: CrowdMind ML Factory CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  PYTHON_VERSION: "3.11"

jobs:
  # ==========================================================================
  # 1. Basic Checks - Installation and imports
  # ==========================================================================
  basic-checks:
    name: "1. Basic Checks"
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .
      
      - name: Verify imports
        run: |
          python -c "from crowdmind_ml.api import CrowdMindAPIClient"
          python -c "from crowdmind_ml.data import DatasetLoader, DataValidator, DataSplitter"
          python -c "from crowdmind_ml.features import FeaturePreprocessor"
          python -c "from crowdmind_ml.model import ModelBuilder, ModelTrainer"
          python -c "from crowdmind_ml.tflite import TFLiteQuantizer"
          python -c "from crowdmind_ml.artifacts import MetadataGenerator, DatasetHasher, RunManager"
          python -c "from crowdmind_ml.cli import load_config, TrainingPipeline"
          echo "✅ All imports successful"
      
      - name: Check syntax (compile all modules)
        run: |
          python -m py_compile src/crowdmind_ml/**/*.py
          echo "✅ No syntax errors"

  # ==========================================================================
  # 2. Code Quality - Formatting and linting
  # ==========================================================================
  code-quality:
    name: "2. Code Quality"
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install ruff black
      
      - name: Check formatting with Black
        run: |
          black --check --diff src/ scripts/ tests/
        continue-on-error: true
      
      - name: Lint with Ruff
        run: |
          ruff check src/ scripts/ --output-format=github
        continue-on-error: true

  # ==========================================================================
  # 3. Unit Tests - Core module tests
  # ==========================================================================
  unit-tests:
    name: "3. Unit Tests"
    runs-on: ubuntu-latest
    needs: basic-checks
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .
          pip install pytest pytest-cov
      
      - name: Run unit tests
        run: |
          pytest tests/unit/ -v --tb=short --cov=src/crowdmind_ml --cov-report=term-missing
      
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: .coverage
          retention-days: 7

  # ==========================================================================
  # 4. ML Smoke Test - Full pipeline with minimal data
  # ==========================================================================
  smoke-test:
    name: "4. ML Smoke Test"
    runs-on: ubuntu-latest
    needs: [basic-checks, unit-tests]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .
          pip install pytest
      
      - name: Run ML smoke test
        run: |
          pytest tests/smoke/ -v --tb=long -s
      
      - name: Verify output files exist
        run: |
          test -f tests/smoke/output/model.tflite && echo "✅ model.tflite exists"
          test -f tests/smoke/output/meta.json && echo "✅ meta.json exists"

  # ==========================================================================
  # 5. Artifacts - Save model and metadata
  # ==========================================================================
  save-artifacts:
    name: "5. Save Artifacts"
    runs-on: ubuntu-latest
    needs: smoke-test
    if: success()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .
          pip install pytest
      
      - name: Run smoke test and generate artifacts
        run: |
          pytest tests/smoke/ -v -s
      
      - name: Upload ML artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ml-artifacts-${{ github.sha }}
          path: |
            tests/smoke/output/model.tflite
            tests/smoke/output/meta.json
          retention-days: 30
      
      - name: Upload test logs
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-${{ github.sha }}
          path: |
            tests/smoke/output/*.log
          retention-days: 14
          if-no-files-found: ignore
